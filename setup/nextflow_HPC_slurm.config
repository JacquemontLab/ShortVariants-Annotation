/*
 * Nextflow SLURM execution template using Apptainer.
 * Configured for the CCDB HPC environment and designed to run fully offline
 * (containers and reference resources are pre-pulled locally).
 */


apptainer.enabled = true
apptainer.autoMounts = true

params {
    batch_size = 3
    fasta_ref = "/lustre09/project/6008022/LAB_WORKSPACE/RAW_DATA/Genetic/Reference_Data/reference_genome/GRCh38_full_analysis_set_plus_decoy_hla.fa.gz"
    vep_cache = "/lustre09/project/6008022/LAB_WORKSPACE/SOFTWARE/VEP/cache/"
} 

process  {
    executor = 'local'

    withLabel: genomics_tools {
        container = '/lustre09/project/6008022/LAB_WORKSPACE/SOFTWARE/Dockers/genomics_tools_latest.sif'
    }

    withLabel: pyspark {
        container = '/lustre09/project/6008022/LAB_WORKSPACE/SOFTWARE/Dockers/pyspark_latest.sif'
    }

    withLabel: duckdb_python {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 16
        container = '/lustre09/project/6008022/LAB_WORKSPACE/SOFTWARE/Dockers/duckdb_python_latest.sif'
    }

    withLabel: ensembl_vep_113 {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 16
        container = '/lustre09/project/6008022/LAB_WORKSPACE/SOFTWARE/Dockers/ensembl_vep_113.3_latest.sif'
    }

    withName: ProduceTSVPerSample {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 16
    }

    withName: MergeTSVParquetByBatch {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 16
    }

    withName: MergeBatches {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 32
    }

    withName: ConvertVEPOutParquet {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 16
    }

    withName: UnFilteredAnnotation {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 64
    }

    withName: CuratedAnnotation {
        executor = 'slurm'
        clusterOptions = '--account=rrg-jacquese'
        time = "1h"
        cpus = 64
    }
}